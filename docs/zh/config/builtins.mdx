# Builtins 内置功能

用于设置 Rspack 提供的内置功能。

- **类型：** `Record<string, any>`
- **默认值：** `{}`

:::warning 稳定性警告

_Builtins_ 提供的内置功能在未来可能会发生变化，或被更好的方式取代，请在升级时注意 builtins 的变化，我们会在 [Release Notes](https://github.com/modern-js-dev/rspack/releases) 中着重标注。

:::

## builtins.emotion

用于设置对 emotion 的编译优化。

- **类型：**

```ts
export type EmotionConfig =
  | boolean
  | {
      sourceMap?: boolean;
      autoLabel?: 'never' | 'dev-only' | 'always';
      labelFormat?: string;
      importMap?: {
        [packageName: string]: {
          [exportName: string]: {
            canonicalImport?: [string, string];
          };
        };
      };
    };
```

- **默认值：** `false`

若你在项目中使用了 `emotion`，并且想要类似 [@emotion/babel-plugin](https://emotion.sh/docs/@emotion/babel-plugin) 的能力，你可以开启 builtins.emotion 配置，启用该配置后，Rspack 会使用 `swc_emotion` 插件对 `emotion` 代码进行转译。

### 示例

你可以直接使用默认配置，直接将 `builtins.emotion` 设置为 `true` 即可。

```ts title="rspack.config.js"
module.exports = {
  context: __dirname,
  entry: {
    main: './src/index.js',
  },
  builtins: {
    emotion: true,
  },
};
```

各字段与 [@emotion/babel-plugin](https://emotion.sh/docs/@emotion/babel-plugin) 保持一致，详细解释（下列内容部分取自 @emotion/babel-plugin 官方文档）：

#### autoLabel

- **类型：** `'never' | 'dev-only' | 'always'`
- **默认值：** `'dev-only'`

这个配置项用于：

- 生成 label 值，这样由 `css` 或者 `styled` 生成的样式中会包含原来的名字，方便调试。
- 注意样式名中非单词字符将被删除。比如 `iconStyles$1` 会变成 `iconStyles1`，因为 `$` 不是合法的 [CSS 类名选择器](https://stackoverflow.com/questions/448981/which-characters-are-valid-in-css-class-names-selectors#449000)。

不同的配置项会产生不同的产物代码：

- `'dev-only'`：只在 Rspack 的 development 模式下开启，在 production 模式下关闭以减小存储占用。
- `'always'`：无论什么模式下都开启该特效。
- `'never'`：无论什么模式下都禁用该特性。

#### labelFormat

- **类型：** `string`
- **默认值：** `'[local]'`

此选项仅在 `'autoLabel'` 设置为 `'dev-only'` 或 `'always'` 时有效。允许你自定义添加的 `label` 的结构。通过字符串定义，其中可变部分用方括号 `'[]'` 括起来。例如对于标签: `'my-classname——[local]'`，其中 `'[local]'` 将被替换为样式变量的名称。

允许的值:

- `'[local]'` - CSS 或样式表达式所在的文件名称
- `'[filename]'` - CSS 或样式表达式所在的文件名称(不带扩展名)。
- `'[dirname]'` - 包含 CSS 或样式表达式所在文件的目录名。

该配置只会影响表达式中的 `label` ，这意味着 CSS 前缀和 hash 会自动被添加。

#### sourceMap

- **类型：** `boolean`

该配置决定是否注入 source maps。production 模式下默认关闭，development 模式下默认开启。

#### importMap

- **类型：**

```ts
export type ImportMap =
  | undefined
  | {
      [packageName: string]: {
        [exportName: string]: {
          canonicalImport?: [string, string];
        };
      };
    };
```

- **默认值：** `undefined`

此选项允许你告诉 Rspack 它应该查看哪些 import 语句，确定应该转换什么，因此如果你重导出 emotion 的方法，仍然可以转换。

## builtins.presetEnv

该配置可以让你的代码运行在更老版本的浏览器上，你可以通过 [browserslist](https://github.com/browserslist/browserslist#queries) 来指定需要支持的所有浏览器。
当源代码中使用了这些浏览器中不支持的 API，则可以通过全局注入 [core-js](https://github.com/zloirock/core-js) 来为这些浏览器提供同样的 API。
如果源代码中使用了这些浏览器中不支持的语法，也会将这些语法转换成浏览器支持的语法。

当该配置项中的 `mode` 不为 undefined 时，请确保项目中依赖了 (core-js)[https://github.com/zloirock/core-js.git]。

- **类型：**

```ts
type PresetEnv = undefined | {
  mode?: 'usage' | 'entry',
  targets?: string[],
  coreJs?: string,
}
```

- **默认值：** `undefined`

| 名称      | 类型                            | 默认值     | 描述 |
| --------- | ------------------------------ | --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `targets` | `string[]\|undefined`          | undefined | 通过该配置可以使用 [browserslist query](https://github.com/browserslist/browserslist#queries) 来控制用户代码中 js 和 css 语法的降级，当此值为 undefined 时，rspack 将尝试使用[基础目录](config/context) 下的 [browserslist](https://github.com/browserslist/browserslist) 配置来进行转换。|
| `mode`    | `'entry'\|'usage'\|undefined`  | undefined | 该配置决定怎样注入 polyfill，`'entry'` 表示根据 [browserslist](https://github.com/browserslist/browserslist#queries) 查询的浏览器，注入所有这些浏览器中缺失的 polyfill，`'usage'` 代表只注入当前代码中需要的 polyfill，当此值为 `undefined` 时则不会注入 polyfill。 |
| `coreJs`  | `string`                       | undefined | 该配置指定注入的 core-js 的版本 |

## builtins.html

该配置可以快速创建与 rspack 产物关联的 html 文件。

- **类型：**

```ts
type BuiltinsHtml = Array<{
  title?: string;
  filename?: string;
  template?: string;
  templateParameters?: Record<string, string>;
  inject?: 'head' | 'body';
  publicPath?: string;
  scriptLoading?: 'blocking' | 'defer' | 'module';
  chunks?: string[];
  excludedChunks?: string[];
  sri?: 'sha256' | 'sha384' | 'sha512';
  minify?: boolean;
  favicon?: string;
  meta?: Record<string, string | Record<string, string>>;
}>;
```

- **默认值：** `[]`

| 名称                 | 类型                                             | 默认值       | 描述                                                                                          |
| -------------------- | ------------------------------------------------ | ------------ | --------------------------------------------------------------------------------------------- |
| `title`              | `string\|undefined`                              | undefined    | 构建 html 的标题                                                                              |
| `filename`           | `string`                                         | 'index.html' | 输出的文件名，可以指定子目录，例如 `pages/index.html`                                         |
| `template`           | `string\|undefined`                              | undefined    | 模版文件路径，支持 ejs                                                                        |
| `templateParameters` | `Record<string, string>`                         | \{\}         | 传递给模版的参数                                                                              |
| `inject`             | `'head'\|'body'\|undefined`                      | undefined    | 产物注入位置                                                                                  |
| `publicPath`         | `string`                                         | ''           | script 和 link 标签的 publicPath                                                              |
| `scriptLoading`      | `'blocking'\|'defer'\|'module'`                  | 'defer'      | 现代浏览器支持使用 defer 来异步加载 js，设置为 module 则会添加 `type="module"` 同时使用 defer |
| `chunks`             | `string[]\|undefined`                            | undefined    | 配置需要注入的 chunk，默认注入所有 chunk                                                      |
| `excludedChunks`     | `string[]\|undefined`                            | undefined    | 配置需要跳过注入的 chunk                                                                      |
| `sri`                | `'sha256'\|'sha384'\|'sha512'\|undefined`        | undefined    | sri hash 算法，默认不开启 sri                                                                 |
| `minify`             | `boolean`                                        | false        | 是否启用压缩                                                                                  |
| `favicon`            | `string\|undefined`                              | undefined    | 配置 html 图标                                                                                |
| `meta`               | `Record<string, string\|Record<string, string>>` | \{\}         | 配置需要注入 html 的 meta                                                                     |

## builtins.minifyOptions

设置内置压缩器配置。

- **类型：**

```ts
type BuiltinsMinifyOptions = {
  passes?: number;
  dropConsole?: boolean;
  pureFuncs?: Array<string>;
};
```

| 名称          | 类型            | 默认值 | 描述                                         |
| ------------- | --------------- | ------ | -------------------------------------------- |
| `passes`      | `number`        | 1      | 运行压缩的最大次数                           |
| `dropConsole` | `boolean`       | false  | 是否移除对 console.\* 函数的调用             |
| `pureFuncs`   | `Array<string>` | []     | 指定无副作用的函数名称，压缩时会丢弃相关语句 |

## builtins.polyfill

当 [target](config/target) 为 browserslist 时此选项有效，当开启时 rspack 将会根据代码自动注入 polyfill。

- **类型：** `boolean`
- **默认值：** `true`

## builtins.define

此选项将会在编辑时将代码中的变量替换为其他值或表达式。

- **类型：** `Record<string, string | boolean | undefined>`
- **默认值：** `{}`

### 示例

```ts title="rspack.config.js"
module.exports = {
  builtins: {
    define: {
      'process.env.NODE_ENV': "'development'",
      API_PREFIX: '/api',
      TRUE: true,
      TRUE_STRING: 'true',
      UNDEFINED: undefined,
      UNDEFINED_STRING: 'undefined',
    },
  },
};
```

输入代码：

```ts
if (process.env.NODE_ENV === 'development') {
  console.log('run in development mode');
}

fetch('API_PREFIX/test');

console.log(TRUE === TRUE_STRING);
console.log(UNDEFINED === UNDEFINED_STRING);
```

输出代码：

```ts
if ('development' === 'development') {
  console.log('run in development mode');
}

fetch('/api/test');

console.log(true === true);
console.log(undefined === undefined);
```

## builtins.react

此选项可以用来配置 react 相关代码的转换。

- **类型：**

```ts
type BuiltinsReact = {
  runtime?: 'automatic' | 'classic';
  importSource?: string;
  pragma?: string;
  pragmaFrag?: string;
  throwIfNamespace?: boolean;
  development?: boolean;
  useBuiltins?: boolean;
  useSpread?: boolean;
  refresh?: boolean;
};
```

- **默认值：** `{}`

| 名称               | 类型                     | 默认值                | 描述                                                                                                                   |
| ------------------ | ------------------------ | --------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| `runtime`          | `'automatic'\|'classic'` | 'automatic'           | automatic 会自动导入 JSX 运行时模块，classic 会使用 `React.createElement` 来进行转换                                   |
| `importSource`     | `string`                 | 'react'               | 当 runtime 为 automatic 时，自动导入的库名称                                                                           |
| `pragma`           | `string`                 | 'React.createElement' | 当 runtime 为 classic 时，编译 JSX 表达式时所替换的函数名                                                              |
| `pragmaFrag`       | `string`                 | 'React.Fragment'      | 编译 JSX fragments 时所使用的组件名                                                                                    |
| `throwIfNamespace` | `boolean`                | true                  | 当使用 xml 命名空间(例如 <f:image />)时是否抛出错误                                                                    |
| `development`      | `boolean`                | false                 | 是否为开发者模式，开发者模式将会在 JSX 元素上导出 `__self` 和 `__source` 以供类似于 React Developer Tools 这类工具使用 |
| `useBuiltins`      | `boolean`                | false                 | 是否使用 `Object.assign()` 代替 `_extends`                                                                             |
| `useSpread`        | `boolean`                | false                 | 是否使用 `Object.assign()` 代替扩展操作符                                                                              |
| `refresh`          | `boolean`                | false                 | 是否启动 react-refresh 相关转换                                                                                        |

## builtins.decorator

此选项可以用来配置装饰器的转换行为，false 表示关闭装饰器转换。

- **类型：**

```ts
type BuiltinsDecorator =
  | boolean
  | {
      legacy?: boolean;
      emitMetadata?: boolean;
    };
```

- **默认值：** `true`

| 名称           | 类型      | 默认值 | 描述                                                                                         |
| -------------- | --------- | ------ | -------------------------------------------------------------------------------------------- |
| `legacy`       | `boolean` | true   | 是否使用[历史（第 1 阶段）](https://github.com/tc39/proposal-decorators)类装饰器的语法和行为 |
| `emitMetadata` | `boolean` | true   | 是否保留 metadata 信息                                                                       |

{/* ## builtins.css */}

{/* ## builtins.postcss */}

{/* ## builtins.treeShaking */}

## builtins.progress

此选项可以用来配置进度条，false 表示不显示进度条。

- **类型：**

```ts
type BuiltinsProgress = boolean | { prefix?: string };
```

- **默认值：** `false`

| 名称     | 类型     | 默认值   | 描述             |
| -------- | -------- | -------- | ---------------- |
| `prefix` | `string` | 'Rspack' | 进度条前显示文案 |

{/* ## builtins.noEmitAssets */}

## builtins.devFriendlySplitChunks

是否开启对开发友好的分包算法。

- **类型：** `boolean`

- **默认值：** `false`
