# Rspack 0.4 å‘å¸ƒå…¬å‘Š

## Rsbuild v0.1 å‘å¸ƒå…¬å‘Š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a0fe4dcdc2264c6f81a72ddeabd51268~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1800&h=579&s=145010&e=png&b=fffdf1)

æˆ‘ä»¬å¾ˆé«˜å…´åœ°å®£å¸ƒ **[Rsbuild](https://github.com/web-infra-dev/rsbuild)** **v0.1** çš„å‘å¸ƒï¼è¿™ä¸ªé‡Œç¨‹ç¢‘è¡¨æ˜ Rsbuild API ç°åœ¨æ›´åŠ ç¨³å®šå¯é ã€‚

Rsbuild æ˜¯åŸºäº Rspack çš„æ„å»ºå·¥å…·ï¼Œæ—¨åœ¨æˆä¸º **æ›´åŠ ç”¨æˆ·å‹å¥½å’Œå¼ºå¤§çš„å¢å¼ºå‹ Rspack CLI**ã€‚ç”±äº Rspack å›¢é˜Ÿå¯¹ Web æ„å»ºæœ€ä½³å®è·µçš„æ¢ç´¢å’Œå®æ–½ï¼ŒRsbuild æ˜¯é‚£äº›å¸Œæœ›ä» Webpack è¿ç§»è‡³ Rspack çš„ç†æƒ³è§£å†³æ–¹æ¡ˆã€‚å®ƒèƒ½å¤Ÿæ˜¾è‘—å‡å°‘ 90% çš„é…ç½®åŒæ—¶æä¾› 10 å€çš„æ„å»ºé€Ÿåº¦ã€‚

### ğŸš€ æ€§èƒ½

Rsbuild çš„æ„å»ºæ€§èƒ½ä¸åŸç”Ÿ Rspack ç›¸å½“ã€‚è€ƒè™‘åˆ° Rsbuild åŒ…å«æ›´å¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œå…¶æ€§èƒ½å°†ç•¥ä½äº Rspackã€‚

è¿™æ˜¯æ„å»º 1000 ä¸ª React ç»„ä»¶æ‰€éœ€çš„æ—¶é—´ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/460cfdfd6d354d61bebc715ae5b511dd~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2976&h=1496&s=47174&e=png&b=272c35)

> æ•°æ®åŸºäº Farm å›¢é˜Ÿæ„å»ºçš„åŸºå‡†æµ‹è¯•ï¼Œæ›´å¤šä¿¡æ¯è¯·å‚é˜… [performance-compare](https://github.com/rspack-contrib/performance-compare)ã€‚

### ğŸ”¥ ç‰¹æ€§

Rsbuild å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- **æ˜“äºé…ç½®**ï¼šRsbuild çš„ç›®æ ‡ä¹‹ä¸€æ˜¯ä¸º Rspack ç”¨æˆ·æä¾›å¼€ç®±å³ç”¨çš„æ„å»ºèƒ½åŠ›ï¼Œå…è®¸å¼€å‘äººå‘˜åœ¨é›¶é…ç½®çš„æƒ…å†µä¸‹å¯åŠ¨ Web é¡¹ç›®ã€‚æ­¤å¤–ï¼ŒRsbuild æä¾›è¯­ä¹‰åŒ–çš„æ„å»ºé…ç½®ï¼Œä»¥å‡å°‘ Rspack é…ç½®çš„å­¦ä¹ æ›²çº¿ã€‚

- **æ€§èƒ½å¯¼å‘**ï¼šRsbuild é›†æˆäº†ç¤¾åŒºä¸­åŸºäºé«˜æ€§èƒ½ Rust çš„å·¥å…·ï¼ŒåŒ…æ‹¬ [Rspack](https://github.com/web-infra-dev/rspack) å’Œ [SWC](https://swc.rs/)ï¼Œä»¥æä¾›ä¸€æµçš„æ„å»ºé€Ÿåº¦å’Œå¼€å‘ä½“éªŒã€‚ä¸åŸºäº webpack çš„å·¥å…·ï¼ˆå¦‚ Create React App å’Œ Vue CLIï¼‰ç›¸æ¯”ï¼ŒRsbuild æä¾›äº† 5 åˆ° 10 å€æ›´å¿«çš„æ„å»ºæ€§èƒ½å’Œæ›´è½»é‡çš„ä¾èµ–ã€‚

- **æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ**ï¼šRsbuild æ‹¥æœ‰è½»é‡çº§çš„æ’ä»¶ç³»ç»Ÿï¼Œå¹¶åŒ…å«ä¸€ç³»åˆ—é«˜è´¨é‡çš„å®˜æ–¹æ’ä»¶ã€‚æ­¤å¤–ï¼ŒRsbuild å…¼å®¹å¤§å¤šæ•° webpack æ’ä»¶å’Œæ‰€æœ‰ Rspack æ’ä»¶ï¼Œå…è®¸ç”¨æˆ·åœ¨ Rsbuild ä¸­åˆ©ç”¨ç°æœ‰ç¤¾åŒºæˆ–å†…éƒ¨æ’ä»¶ï¼Œè€Œæ— éœ€é‡å†™ä»£ç ã€‚

- **ç¨³å®šçš„æ„å»ºäº§ç‰©**ï¼šRsbuild è®¾è®¡æ—¶å¼ºè°ƒæ„å»ºäº§ç‰©çš„ç¨³å®šæ€§ã€‚å®ƒç¡®ä¿å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§æ„å»ºä¸­çš„äº§ç‰©ä¹‹é—´å…·æœ‰é«˜ä¸€è‡´æ€§ï¼Œå¹¶è‡ªåŠ¨å®Œæˆè¯­æ³•é™çº§å’Œ polyfill æ³¨å…¥ã€‚Rsbuild è¿˜æä¾›ç”¨äºç±»å‹æ£€æŸ¥å’Œäº§ç‰©è¯­æ³•éªŒè¯çš„æ’ä»¶ï¼Œä»¥é˜²æ­¢ç”Ÿäº§ä»£ç ä¸­çš„è´¨é‡å’Œå…¼å®¹æ€§é—®é¢˜ã€‚

- **æ¡†æ¶æ— å…³**ï¼šRsbuild ä¸ä¸ä»»ä½•å‰ç«¯ UI æ¡†æ¶è€¦åˆã€‚å®ƒé€šè¿‡æ’ä»¶æ”¯æŒ Reactã€Vue 3ã€Vue 2ã€Svelte å’Œ Lit ç­‰æ¡†æ¶ï¼Œå¹¶è®¡åˆ’æœªæ¥æ”¯æŒæ›´å¤š UI æ¡†æ¶ã€‚

## ä¸»è¦å˜åŠ¨

### åœæ­¢æ”¯æŒ Node.js 14

Rspack ä¸å†æ”¯æŒ Node.js 14ï¼Œç°åœ¨éœ€è¦ Node.js 16+ã€‚

### å°† @rspack/core è®¾ä¸º @rspack/cli çš„ peerDep

`@rspack/core` ç°åœ¨æ˜¯ `@rspack/cli` çš„ peerDependencyï¼Œè€Œä¸æ˜¯ç›´æ¥çš„ä¾èµ–å…³ç³»ã€‚è¿™æ„å‘³ç€ç°åœ¨æ‚¨éœ€è¦æ‰‹åŠ¨å®‰è£… `@rspack/core` å’Œ `@rspack/cli`ã€‚è¿™ä½¿å¾— Rspack æ›´åŠ æ¥è¿‘ webpackã€‚ä»é•¿è¿œæ¥çœ‹ï¼Œ`@rspack/cli` çš„å®šä½å°†ä¸å†æ˜¯å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬å»ºè®®ä½¿ç”¨ [Rsbuild](https://rsbuild.dev/) ä½œä¸ºå¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚

### åºŸå¼ƒé»˜è®¤è½¬æ¢

`experiments.rspackFuture.disableTransformByDefault` åœ¨ v0.4.0 ä¸­é»˜è®¤å¯ç”¨ã€‚å¯¹äºä»éœ€è¦æ—§è¡Œä¸ºçš„ç”¨æˆ·ï¼Œå¯ä»¥æ‰‹åŠ¨å°†æ­¤é€‰é¡¹è®¾ç½®ä¸º `false`ã€‚

æ­¤åŠŸèƒ½ä¸»è¦è§£å†³ä¸‰ç±»é—®é¢˜ï¼š[å†…ç½®](https://www.rspack.dev/config/builtins) ä»£ç è½¬æ¢åŠŸèƒ½ï¼Œ[ç›®æ ‡](https://www.rspack.dev/config/target)ï¼Œå’Œè‡ªå®šä¹‰ [Rule.type](https://www.rspack.dev/config/module#ruletype)ã€‚

1. ç§»é™¤å¯¹ä¸€äº› [[å†…ç½®](https://www.rspack.dev/config/builtins)](https://www.rspack.dev/config/builtins) åŠŸèƒ½çš„æ”¯æŒï¼š

- [[builtins.relay](https://www.rspack.dev/config/builtins#builtinsrelay)](https://www.rspack.dev/config/builtins#builtinsrelay)ï¼šç§»åŠ¨åˆ° `rspackExperiments.relay`
- [[builtins.react](https://www.rspack.dev/config/builtins#builtinsreact)](https://www.rspack.dev/config/builtins#builtinsreact)ï¼šç§»åŠ¨åˆ° `jsc.transform.react`
- [[builtins.emotion](https://www.rspack.dev/config/builtins#builtinsemotion)](https://www.rspack.dev/config/builtins#builtinsemotion)ï¼šç§»åŠ¨åˆ° `rspackExperiments.emotion`
- [[builtins.pluginImport](https://www.rspack.dev/config/builtins#builtinspluginimport)](https://www.rspack.dev/config/builtins#builtinspluginimport)ï¼šç§»åŠ¨åˆ° `rspackExperiments.import`
- [[builtins.decorator](https://www.rspack.dev/config/builtins#builtinsdecorator)](https://www.rspack.dev/config/builtins#builtinsdecorator)ï¼šç§»åŠ¨åˆ° `jsc.parser.decorator`
- [[builtins.presetEnv](https://www.rspack.dev/config/builtins#builtinspresetenv)](https://www.rspack.dev/config/builtins#builtinspresetenv)ï¼šç§»åŠ¨åˆ° `jsc.env`

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /.jsx$/,
        loader: 'builtin:swc-loader',
        options: {
          jsc: {
            parser: {
              syntax: "ecmascript",
              jsx: true
            }
          },
          rspackExperiments: {
            emotion: true // ä¸ `builtins` ç›¸åŒ
          }
        }
        type: 'javascript/auto',
      },
    ],
  },
  experiments: {
    rspackFuture: {
      disableTransformByDefault: true
    }
  }
};
```

2. [[target](https://www.rspack.dev/config/target)](https://www.rspack.dev/config/target) ä¸ä¼šé™çº§ç”¨æˆ·ç«¯ä»£ç 

```diff
module.exports = {
  target: ["web", "es5"],
  module: {
    rules: [
      {
        test: /.js$/,
        exclude: /node_modules/,
        loader: 'builtin:swc-loader',
        options: {
          jsc: {
            parser: {
              syntax: "ecmascript"
            },
+           target: "es5" // æ³¨æ„ï¼š`jsc.target` å’Œ `env` ä¸èƒ½åŒæ—¶è®¾ç½®ã€‚
          },
+        env: { // æ³¨æ„ï¼š`jsc.target` å’Œ `env` ä¸èƒ½åŒæ—¶è®¾ç½®ã€‚
+         targets: "chrome >= 48"
+        }
        }
        type: 'javascript/auto',
      },
    ],
  }
};
```

3. ç§»é™¤é webpack å…¼å®¹çš„ [[Rule.type](```

## åºŸå¼ƒ builtin.react.refresh

ç”±äºåœ¨ v0.4.0 ä¸­é»˜è®¤å¯ç”¨äº† `experiments.rspackFuture.disableTransformByDefault`ï¼Œ`builtin.react.refresh` ä¹Ÿå·²è¢«åºŸå¼ƒã€‚ç°åœ¨æˆ‘ä»¬å»ºè®®ä½¿ç”¨ `@rspack/plugin-react-refresh` æ¥å¯ç”¨ React å¿«é€Ÿåˆ·æ–°ã€‚

```diff
+ const ReactRefreshPlugin = require('@rspack/plugin-react-refresh');
const isDev = process.env.NODE_ENV === 'development';

module.exports = {
  // ...
  mode: isDev ? 'development' : 'production',
  module: {
    rules: [
      {
        test: /.jsx$/,
        use: {
          loader: 'builtin:swc-loader',
          options: {
            jsc: {
              parser: {
                syntax: 'ecmascript',
                jsx: true,
              },
              transform: {
                react: {
+                  development: isDev,
+                  refresh: isDev,
                },
              },
            },
          },
        },
      },
    ],
  },
-  builtins: {
-    react: {
-      refresh: true,
-    }
-  },
  plugins: [
+    isDev && new ReactRefreshPlugin()
  ].filter(Boolean),
};
```

æŸ¥çœ‹æ›´å¤šè¯¦æƒ…ï¼Œè¯·è®¿é—® [è¿™é‡Œ](https://www.rspack.dev/zh/guide/react.html#fast-refresh)ã€‚

### åºŸå¼ƒ builtin:sass-loader

`builtin:sass-loader` ç°å·²è¢«åºŸå¼ƒã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨å®ƒï¼Œè¯·è¿ç§»åˆ° `sass-loader`ã€‚Rspack å°†åœ¨ v0.5.0 ä¸­ç§»é™¤ `builtin:sass-loader`ã€‚

### åºŸå¼ƒ experiments.incrementalRebuild

`experiments.incrementalRebuild` ç°å·²è¢«åºŸå¼ƒã€‚Rspack å°†åœ¨ v0.5.0 ä¸­ç§»é™¤å®ƒã€‚

### é‡æ„ @rspack/core ä¸­çš„å¯¼å‡º API

ä»¥å‰ï¼Œä¸€äº› API å¯èƒ½ä¼šé€šè¿‡ä» @rspack/core é‡æ–°å¯¼å‡ºè€Œè¢«æ„å¤–å¯¼å‡ºã€‚ç°åœ¨é€šè¿‡æ­¤é‡æ„ï¼Œæˆ‘ä»¬ä» @rspack/core ä¸­æ¸…ç†äº†å¯¼å‡ºçš„ APIã€‚

è¿™ä¸åº”è¯¥é€ æˆä»»ä½•é—®é¢˜ï¼Œä½†å¦‚æœæ‚¨æ„å¤–å¯¼å‡ºäº† APIï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæ‚¨å¯èƒ½ä¼šä»¥ä¸æ­£ç¡®çš„æ–¹å¼ä½¿ç”¨ Rspackã€‚

å¦‚æœç¡®å®æœ‰éœ€è¦ä»æ­¤é‡æ„ä¸­ç§»é™¤çš„ APIï¼Œè¯·åœ¨ Rspack ä»“åº“ä¸­æå‡ºé—®é¢˜ã€‚

### åºŸå¼ƒ `builtins.devFriendlySplitChunks` å’Œ `experiments.new_split_chunks`

ä¸ºäº†å®Œå…¨è¿ç§»åˆ° Webpack çš„åˆ†å‰²å—å®ç°ï¼Œè¿™äº›å­—æ®µå·²è¢«åºŸå¼ƒã€‚Rspack å°†åœ¨ v0.5.0 ä¸­ç§»é™¤è¿™äº›å­—æ®µã€‚

### é»˜è®¤å¯ç”¨æ–°çš„è§£æå™¨

[oxc_resolver](https://crates.io/crates/oxc_resolver) ç°åœ¨é»˜è®¤å¯ç”¨ã€‚

`oxc_resolver` æ˜¯ç”± [oxc é¡¹ç›®](https://github.com/oxc-project/oxc) æä¾›çš„ç”¨ Rust ç¼–å†™çš„æ¨¡å—è§£æå™¨ã€‚æ–°è§£æå™¨å·²é€šè¿‡äº† [enhanced-resolve](https://www.npmjs.com/package/enhanced-resolve) çš„æ‰€æœ‰æµ‹è¯•å¥—ä»¶ã€‚å®ƒæ¯”ä»¥å‰çš„å®ç°å¿« 5 å€ï¼Œæ¯” enhanced-resolve å¿« 28 å€ã€‚

æ–°è§£æå™¨å¯ä»¥é…ç½®ä¸ºè¯»å– `tsconfig.json` çš„ `compilerOptions.paths` å’Œ `references` å­—æ®µ,å¯¹ monorepo çš„åµŒå¥— alias æä¾›äº†å†…ç½®æ”¯æŒã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… API [resolve.tsConfig](https://www.rspack.dev/config/resolve.html#resolvetsconfig)ã€‚

è¦é€€å‡ºæ–°è§£æå™¨ï¼Œè¯·å°† `experiments.rspackFuture.newResolver` è®¾ç½®ä¸º `false`ã€‚

## Migration Guide

è¿ç§»ç¤ºä¾‹ [migrate example](https://github.com/rspack-contrib/rspack-examples/pull/2) å±•ç¤ºäº†å¦‚ä½•ä» Rspack 0.3.14 è¿ç§»åˆ° Rspack 0.4.0

### é€‰æ‹© `@rspack/cli` è¿˜æ˜¯ `Rsbuild`ï¼Ÿ

å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºæ˜¯ CSR åº”ç”¨ç¨‹åºï¼Œåˆ™æˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨ä½¿ç”¨ Rsbuild è€Œä¸æ˜¯è‡ªè¡Œé…ç½® Rspackï¼Œå› ä¸ºä¸ `@rspack/cli` ç›¸æ¯”ï¼ŒRsbuild æ›´å®¹æ˜“ä½¿ç”¨ã€‚

### å‡çº§ Node.js ç‰ˆæœ¬

è‡ª 0.4.0 èµ·ï¼ŒRspack ä¸å†æ”¯æŒ Node.js 14ï¼Œç°åœ¨ä»…æ”¯æŒ Node.js 16+ã€‚

### éœ€è¦æ‰‹åŠ¨å®‰è£… `@rspack/core`

```diff title=package.json
{
  "devDependencies": {
+    "@rspack/core": "0.4.0",
     "@rspack/cli": "0.4.0"
  }
}
```

### ä½¿ç”¨å†…ç½®çš„ `swc-loader` æ”¯æŒæ¨¡å—è½¬æ¢

è‡ª 0.4.0 èµ·ï¼ŒRspack ä¸å†é»˜è®¤è½¬æ¢æ–‡ä»¶ï¼Œå› æ­¤ç°åœ¨éœ€è¦ä½¿ç”¨ `builtin:swc-loader` æ¥è½¬æ¢æ–‡ä»¶ï¼Œæ›´å¤šè¯¦æƒ…è¯·å‚é˜… [Deprecating default transformation](#åºŸå¼ƒé»˜è®¤è½¬æ¢)ã€‚

### å¯¹äº React åº”ç”¨ç¨‹åºï¼Œè¯·ä½¿ç”¨ `@rspack/plugin-react-refresh` æ¥æ”¯æŒ Fast Refresh

å½“æˆ‘ä»¬ç¦ç”¨é»˜è®¤è½¬æ¢æ—¶ï¼Œ`builtin.react.refresh` å°†æ— æ³•å·¥ä½œï¼Œå› æ­¤æ‚¨éœ€è¦ä½¿ç”¨ `@rspack/plugin-react-refresh` æ¥å¯ç”¨ Fast Refreshï¼Œæ›´å¤šç»†èŠ‚è¯·å‚é˜… [Deprecating builtin.react.refresh](#åºŸå¼ƒ-builtinreactrefresh)ã€‚
